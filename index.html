<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²œì¼ë„+ v3.2 - ì „ë¬¸ ìƒë‹´ ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --accent: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        nav { background: var(--primary); color: white; padding: 15px; display: flex; gap: 20px; position: sticky; top: 0; z-index: 100; }
        .nav-item { cursor: pointer; padding: 10px 20px; border-radius: 5px; font-weight: bold; }
        .nav-item.active { background: var(--secondary); }
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h2 { color: var(--primary); border-left: 5px solid var(--secondary); padding-left: 10px; font-size: 18px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; margin-bottom: 12px; }
        .btn-group { display: flex; gap: 10px; }
        .btn { border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; flex: 1; }
        .btn-blue { background: var(--secondary); color: white; }
        .btn-gray { background: #95a5a6; color: white; }
        .btn-list { background: #34495e; color: white; width: 100%; text-align: left; padding: 15px; margin-bottom: 8px; border: none; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        /* ë¦¬í¬íŠ¸ ë””ìì¸ */
        .result-box { background: #fff; border: 2px solid var(--primary); padding: 30px; border-radius: 15px; margin-top: 15px; display: none; line-height: 1.6; }
        .saju-badge { background: #f8f9fa; padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 24px; border: 1px solid #ddd; margin: 0 4px; }
        .distribution-box { background: #eef7ff; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #3498db; }
        .code-banner { background: var(--accent); color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; font-weight: bold; margin: 15px 0; }
        .item-box { padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        @media print { .no-print, nav, .btn, h2 { display: none !important; } .result-box { display: block !important; border: none; padding: 0; } }
    </style>
</head>
<body>

<nav>
    <div class="nav-item active" id="nav-reg" onclick="showTab('register')">1. ê³ ê°ì ‘ìˆ˜</div>
    <div class="nav-item" id="nav-con" onclick="showTab('consult')">2. ì „ë¬¸ìƒë‹´</div>
</nav>

<div class="container">
    <section id="register" class="view-section active">
        <div class="card">
            <h2>ê³ ê° ì •ë³´ ë° ì²´ì§ˆ ë¬¸ì§„</h2>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="name" placeholder="ì„±í•¨">
                <select id="gender" style="flex: 0.4;"><option value="ì—¬">ì—¬ì„±</option><option value="ë‚¨">ë‚¨ì„±</option></select>
            </div>
            <input type="tel" id="phone" placeholder="ì „í™”ë²ˆí˜¸">
            <input type="text" id="saju_ko" placeholder="ì‚¬ì£¼ì›êµ­ (ì˜ˆ: ì‹ í•´ ê¸°í•´ ì„ì¸ ê¸°ìœ )">
            
            <p style="font-weight: bold; margin-top: 20px;">[ì¦ìƒ ì²´í¬]</p>
            <div id="survey-questions"></div> <div class="btn-group">
                <button class="btn btn-blue" onclick="saveCustomer()">ì „ì†¡ ì™„ë£Œ</button>
                <button class="btn btn-gray" onclick="resetForm()">ë¦¬ì…‹</button>
            </div>
        </div>
    </section>

    <section id="consult" class="view-section">
        <div class="card no-print">
            <h2>ëŒ€ê¸° ê³ ê° ëª©ë¡</h2>
            <div id="recent-list"></div>
        </div>

        <div id="consult-area" style="display:none;">
            <div class="card no-print">
                <h2 id="targetDisplay">ìƒë‹´ ì§„í–‰ ì¤‘</h2>
                <p><strong>[ì¸ë°”ë”” ë°ì´í„° ì…ë ¥]</strong></p>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 10px;">
                    <input type="number" id="w1" placeholder="ê´€ë¦¬ ì „ ì²´ì¤‘">
                    <input type="number" id="f1" placeholder="ê´€ë¦¬ ì „ ì²´ì§€ë°©">
                    <input type="number" id="w2" placeholder="ê´€ë¦¬ í›„ ì²´ì¤‘">
                    <input type="number" id="f2" placeholder="ê´€ë¦¬ í›„ ì²´ì§€ë°©">
                </div>
                <button class="btn btn-blue" onclick="generateReport()">ë¶„ì„ ë¦¬í¬íŠ¸ ë°œí–‰</button>
                <button class="btn btn-gray" style="margin-top:10px;" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
            </div>

            <div id="final-report" class="result-box">
                <div style="text-align: center; border-bottom: 2px solid #333; pb: 10px; mb: 20px;">
                    <h1 style="margin:0; color:var(--primary);">ì²œì¼ë„+ ì²´ì§ˆ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
                    <p id="res-info" style="font-weight: bold;"></p>
                </div>

                <div id="saju-hanja" style="text-align:center; margin-bottom: 20px;"></div>

                <div class="distribution-box">
                    <strong>ğŸ“Š ì˜¤í–‰ ê¸°ìš´ ë° ê±´ê°• ë¶„ì„</strong><br>
                    <span id="res-dist" style="font-size: 15px;"></span>
                </div>

                <div class="code-banner" id="res-code"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="item-box" style="background:#fff5eb;"><strong>ğŸµ ì›°ì»´ ë¶€ìŠ¤í„°</strong><br><span id="res-tea"></span></div>
                    <div class="item-box" style="background:#fffbe6;"><strong>ğŸ”® ë§ˆìŒ ìŠµê´€</strong><br><span id="res-mind"></span></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="item-box"><strong>ğŸ¯ í…Œë¼í”¼ ì²˜ë°©</strong><br><span id="res-therapy"></span></div>
                    <div class="item-box"><strong>ğŸ’Š ë§ì¶¤ ì˜ì–‘</strong><br><span id="res-atomy"></span></div>
                </div>

                <div class="item-box" style="background:#eef7ff; border-color:#3498db;">
                    <strong>ğŸ’¡ ì†¡ì€ìˆ™ ì›ì¥ë‹˜ì˜ ì „ë¬¸ ì§„ë‹¨</strong><br><span id="res-ment"></span>
                </div>

                <div style="text-align:center; margin-top:30px; font-weight:bold; font-size: 18px;">"ì²´ì˜¨ 1ë„ê°€ ë‹¹ì‹ ì˜ ìš´ëª…ì„ ë°”ê¿‰ë‹ˆë‹¤."</div>
            </div>
        </div>
    </section>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAUucRqU8nciqkINbjZcUUHx3UkR_OOprs", authDomain: "cheon1do-plus.firebaseapp.com", projectId: "cheon1do-plus", storageBucket: "cheon1do-plus.firebasestorage.app", messagingSenderId: "344900999016", appId: "1:344900999016:web:a20ef3b01df68ca03928dd" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentCustomer = null;

    const questions = [
        {id:'W', q:'ì–´ê¹¨/ëª© ê·¼ìœ¡ì´ ìì£¼ ë­‰ì¹˜ì‹œë‚˜ìš”?'},
        {id:'H', q:'ì–¼êµ´ë¡œ ì—´ì´ ì˜¤ë¥´ê±°ë‚˜ ë‘ê·¼ê±°ë¦¬ì‹œë‚˜ìš”?'},
        {id:'T', q:'ì†Œí™”ê°€ ì˜ ì•ˆ ë˜ê³  ìƒê°ì´ ë§ìœ¼ì‹ ê°€ìš”?'},
        {id:'M', q:'í”¼ë¶€ê°€ ê±´ì¡°í•˜ê³  ë©´ì—­ì´ ì•½í•˜ì‹ ê°€ìš”?'},
        {id:'S', q:'ëª¸ì´ ì˜ ë¶“ê³  ì†ë°œì´ ì°¨ê°€ìš°ì‹ ê°€ìš”?'}
    ];

    window.onload = () => {
        const container = document.getElementById('survey-questions');
        questions.forEach(item => {
            container.innerHTML += `<label style="font-size:14px;">${item.q}</label>
            <select id="${item.id}_val"><option value="1">ì•„ë‹˜</option><option value="3" selected>ë³´í†µ</option><option value="5">ì‹¬í•¨</option></select>`;
        });
    };

    function showTab(t) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.getElementById(t === 'register' ? 'nav-reg' : 'nav-con').classList.add('active');
        if(t === 'consult') loadRecentCustomers();
    }

    async function saveCustomer() {
        const name = document.getElementById('name').value;
        if(!name) return alert("ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        const data = {
            name, gender: document.getElementById('gender').value,
            phone: document.getElementById('phone').value,
            saju_ko: document.getElementById('saju_ko').value,
            scores: { W: document.getElementById('W_val').value, H: document.getElementById('H_val').value, T: document.getElementById('T_val').value, M: document.getElementById('M_val').value, S: document.getElementById('S_val').value },
            createdAt: new Date()
        };
        await db.collection("clients").add(data);
        alert("ë°ì´í„° ì „ì†¡ ì™„ë£Œ! ìƒë‹´ì‹¤ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
        resetForm();
        showTab('consult');
    }

    function resetForm() {
        document.getElementById('name').value = ""; document.getElementById('phone').value = ""; document.getElementById('saju_ko').value = "";
    }

    async function loadRecentCustomers() {
        const snap = await db.collection("clients").orderBy("createdAt", "desc").limit(5).get();
        const listDiv = document.getElementById('recent-list');
        listDiv.innerHTML = "";
        if(snap.empty) { listDiv.innerHTML = "<p>ëŒ€ê¸° ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }
        snap.forEach(doc => {
            const d = doc.data();
            const time = d.createdAt ? d.createdAt.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
            const btn = document.createElement('button');
            btn.className = 'btn-list';
            btn.innerHTML = `<span>${d.name}(${d.gender})</span> <span>${time} ì ‘ìˆ˜</span>`;
            btn.onclick = () => selectCustomer(doc.id, d);
            listDiv.appendChild(btn);
        });
    }

    function selectCustomer(id, data) {
        currentCustomer = { id, ...data };
        document.getElementById('consult-area').style.display = 'block';
        document.getElementById('final-report').style.display = 'none';
        document.getElementById('targetDisplay').innerText = data.name + "ë‹˜ ìƒë‹´/ì¸ë°”ë”” ì…ë ¥";
    }

    const hanjaMap = {'ì‹ ':'è¾›','í•´':'äº¥','ê¸°':'å·±','ì„':'å£¬','ì¸':'å¯…','ìœ ':'é…‰','ì':'å­','ì¶•':'ä¸‘','ë³‘':'ä¸™','ì •':'ä¸','ë¬´':'æˆŠ','ê²½':'åºš','ì„':'ä¹™','ê°‘':'ç”²','ê³„':'ç™¸','ë¯¸':'æœª','ìˆ ':'æˆŒ','ì§„':'è¾°','ì‚¬':'å·³','ì˜¤':'åˆ','ë¬˜':'å¯'};
    const ohaengMap = {'è¾›':'ê¸ˆ','åºš':'ê¸ˆ','é…‰':'ê¸ˆ','ç”³':'ê¸ˆ','å£¬':'ìˆ˜','ç™¸':'ìˆ˜','äº¥':'ìˆ˜','å­':'ìˆ˜','ç”²':'ëª©','ä¹™':'ëª©','å¯…':'ëª©','å¯':'ëª©','ä¸™':'í™”','ä¸':'í™”','å·³':'í™”','åˆ':'í™”','æˆŠ':'í† ','å·±':'í† ','è¾°':'í† ','æˆŒ':'í† ','ä¸‘':'í† ','æœª':'í† '};

    function generateReport() {
        const saju = currentCustomer.saju_ko || "";
        const hanjas = saju.split(' ').map(h => hanjaMap[h] || h);
        const counts = {'ëª©':0, 'í™”':0, 'í† ':0, 'ê¸ˆ':0, 'ìˆ˜':0};
        hanjas.forEach(hj => { if(ohaengMap[hj]) counts[ohaengMap[hj]]++; });

        const s = currentCustomer.scores;
        const maxO = Object.keys(s).reduce((a, b) => parseInt(s[a]) > parseInt(s[b]) ? a : b);
        let res = {};

        // ì˜¤í–‰ ë¶„ì„ ë©˜íŠ¸ ìƒì„±
        let distText = `ë¶„ì„ ê²°ê³¼, ê³ ê°ë‹˜ì€ [${Object.entries(counts).filter(e=>e[1]>0).map(e=>e[0]+e[1]).join(', ')}] ê¸°ìš´ì„ íƒ€ê³ ë‚˜ì…¨ìŠµë‹ˆë‹¤. `;
        if(counts['ìˆ˜'] >= 3) distText += "íŠ¹íˆ ë¬¼(æ°´)ì˜ ê¸°ìš´ì´ ê°•í•´ í•˜ì²´ ëƒ‰ì¦ê³¼ ë¶€ì¢…ì„ ì£¼ì˜í•´ì•¼ í•˜ëŠ” ì²´ì§ˆì…ë‹ˆë‹¤.";
        else if(counts['í™”'] >= 3) distText += "ë¶ˆ(ç«)ì˜ ê¸°ìš´ì´ ê°•í•´ ì‹¬ì¥ ì—´ê°ê³¼ ìƒê¸°ë˜ëŠ” ì¦ìƒì„ ì¡°ì ˆí•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.";
        else distText += "ì „ë°˜ì ì¸ ì˜¤í–‰ì˜ íë¦„ì„ ì¡°ìœ¨í•˜ì—¬ ìê°€ ë©´ì—­ë ¥ì„ ë†’ì´ëŠ” ì²˜ë°©ì´ í•„ìš”í•©ë‹ˆë‹¤.";

        if(maxO === 'S') {
            res = { code: "S3R ìˆœí™˜ì •ì²´í˜•", therapy: "ì˜¨ì—´ 40ë¶„ + ì›¨ì´ë¸Œ 20ë¶„", atomy: "í—¤ëª¨í˜, ì˜¤ë©”ê°€3, ë³´ì´ì°¨", tea: "ê°•í•œ ìˆ˜ë…ì„ ë°€ì–´ë‚´ê¸° ìœ„í•´ í™ì‚¼ë‹¨ì˜ ë”°ëœ»í•œ ì„±ì§ˆë¡œ ì†ë¶ˆì„ ì§€í´ì•¼ í•©ë‹ˆë‹¤.", mind: "í˜¼ì ì°¸ëŠ” ìŠµê´€ì´ ëª¸ì„ ë¶“ê²Œ í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ì€ ê³ ë¯¼ì„ ë•€ê³¼ í•¨ê»˜ ë¹„ì›Œë‚´ì„¸ìš”.", ment: "ê¸°í˜ˆì˜ í˜ìœ¼ë¡œ ëƒ‰ê¸°ë¥¼ ëª°ì•„ë‚¼ ë•Œ ì§„ì§œ ìˆœí™˜ì´ ì‹œì‘ë©ë‹ˆë‹¤." };
        } else if(maxO === 'T') {
            res = { code: "T3M ì†Œí™”ì •ì²´í˜•", therapy: "ì˜¨ì—´ 30ë¶„ + ì›¨ì´ë¸Œ 30ë¶„", atomy: "í—¤ëª¨í˜, ìœ ì‚°ê· , íš¨ì†Œ", tea: "ìƒê°ì´ ë§ì•„ êµ³ì–´ë²„ë¦° ìœ„ì¥ì„ í™ì‚¼ì˜ ì˜¨ê¸°ë¡œ ë¶€ë“œëŸ½ê²Œ ê¹¨ì›Œì¤ë‹ˆë‹¤.", mind: "ì™„ë²½ì£¼ì˜ëŠ” ë…ì…ë‹ˆë‹¤. ë‡Œë¥¼ ì‰¬ê²Œ í•´ì•¼ ìœ„ì¥ë„ í¸ì•ˆí•˜ê²Œ ì›€ì§ì…ë‹ˆë‹¤.", ment: "ì†ì´ í¸ì•ˆí•´ì§€ë©´ ì•ˆìƒ‰ê³¼ í”¼ë¶€ê°€ ëˆˆì— ë„ê²Œ ë§‘ì•„ì§‘ë‹ˆë‹¤." };
        } else {
            res = { code: "ì²´ì§ˆ ë°¸ëŸ°ìŠ¤ ì¡°ì •í˜•", therapy: "ì˜¨ì—´ 40ë¶„ (ê¸°ë³¸ ì§‘ì¤‘)", atomy: "í—¤ëª¨í˜, ë©€í‹°ë¹„íƒ€ë¯¼", tea: "ê¸°ì´ˆ ëŒ€ì‚¬ë¥¼ ë†’ì—¬ì£¼ëŠ” í™ì‚¼ë‹¨ìœ¼ë¡œ ì²´ì˜¨ 1ë„ë¥¼ ì˜¬ë¦¬ëŠ” ë§ˆì¤‘ë¬¼ì„ ë“œë¦½ë‹ˆë‹¤.", mind: "ë‚´ ëª¸ì„ ì‚¬ë‘í•˜ëŠ” ì‹œê°„ì´ ìš´ëª…ì„ ë°”ê¿‰ë‹ˆë‹¤. ê¸ì •ì˜ ì—ë„ˆì§€ë¥¼ ì±„ìš°ì„¸ìš”.", ment: "ë¬´ë„ˆì§„ ë©´ì—­ ë°¸ëŸ°ìŠ¤ë¥¼ ì˜¨ì—´ë¡œ ë‹¤ì‹œ ê²¬ê³ í•˜ê²Œ ì„¸ì›ë‹ˆë‹¤." };
        }

        document.getElementById('res-info').innerText = `${currentCustomer.name}(${currentCustomer.gender}) / ${currentCustomer.phone}`;
        document.getElementById('res-dist').innerText = distText;
        document.getElementById('res-code').innerText = res.code;
        document.getElementById('res-tea').innerText = res.tea;
        document.getElementById('res-mind').innerHTML = res.mind;
        document.getElementById('res-therapy').innerText = res.therapy;
        document.getElementById('res-atomy').innerText = res.atomy;
        document.getElementById('res-ment').innerText = res.ment;
        
        document.getElementById('saju-hanja').innerHTML = hanjas.map(h => `<span class="saju-badge">${h}</span>`).join('');
        document.getElementById('final-report').style.display = 'block';
    }
</script>
</body>
</html>
