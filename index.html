<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²œì¼ë„+ v6.0 ìµœì¢…ì™„ì„±</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --bg: #f4f7f6; --ëª©: #27ae60; --í™”: #e74c3c; --í† : #f39c12; --ê¸ˆ: #7f8c8d; --ìˆ˜: #2980b9; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        
        /* [ë‹¨ë½ 1] ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ - í™”ë©´ ë¶„ë¦¬ì˜ í•µì‹¬ */
        nav { background: var(--primary); color: white; padding: 15px; display: flex; gap: 10px; position: sticky; top: 0; z-index: 1000; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-item { cursor: pointer; padding: 12px 25px; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .nav-item.active { background: var(--secondary); }
        
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; }
        
        /* í™”ë©´ ì „í™˜ìš© ì„¤ì •: ì•ˆ ì“°ëŠ” íƒ­ì€ ì•„ì˜ˆ ê³µê°„ë„ ì°¨ì§€í•˜ì§€ ì•Šê²Œ ì°¨ë‹¨ */
        .view-section { display: none; }
        .view-section.active { display: block !important; }

        h2 { border-left: 5px solid var(--secondary); padding-left: 12px; font-size: 19px; margin-bottom: 20px; color: var(--primary); }
        input, select { width: 100%; padding: 13px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 12px; font-size: 16px; box-sizing: border-box; }
        
        .btn { border: none; padding: 16px; border-radius: 10px; cursor: pointer; font-size: 17px; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-blue { background: var(--secondary); color: white; }
        .btn-list { background: #34495e; color: white; text-align: left; padding: 18px; margin-bottom: 10px; border: none; border-radius: 12px; width: 100%; cursor: pointer; display: flex; justify-content: space-between; }

        /* [ë‹¨ë½ 2] ì‚¬ì£¼ ì¹´ë“œ ë””ìì¸ - ì´ë¯¸ì§€ì™€ ë™ì¼í™” */
        .saju-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 25px 0; }
        .saju-box { background: #f9fbff; border: 1px solid #e1e8f0; border-radius: 15px; padding: 15px 5px; text-align: center; }
        .saju-label { font-size: 13px; color: #7f8c8d; margin-bottom: 8px; }
        .saju-char { font-size: 28px; font-weight: bold; margin: 5px 0; line-height: 1.2; }

        /* [ë‹¨ë½ 3] ì˜¤í–‰ ê·¸ë˜í”„ ë””ìì¸ */
        .graph-row { margin-bottom: 15px; }
        .graph-label { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-bottom: 6px; }
        .bar-bg { background: #eee; border-radius: 20px; height: 16px; overflow: hidden; width: 100%; }
        .bar-fill { height: 100%; border-radius: 20px; transition: width 1s; }

        /* ë¦¬í¬íŠ¸ ë ˆì´ì•„ì›ƒ */
        .result-box { background: white; padding: 35px; border-radius: 20px; border: 2px solid #333; margin-top: 20px; display: none; }
        .health-tip { background: #eef7ff; padding: 20px; border-radius: 12px; border-left: 6px solid var(--secondary); margin: 20px 0; line-height: 1.7; }
        .atomy-box { background: #fff5f5; border: 2px solid #feb2b2; padding: 20px; border-radius: 12px; margin: 15px 0; }
        .code-tag { background: var(--í™”); color: white; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; font-size: 22px; margin: 20px 0; }

        @media print { 
            nav, .no-print, .btn, h2 { display: none !important; } 
            .result-box { display: block !important; border: 1px solid #000; box-shadow: none; border-radius: 0; padding: 0; }
            .container { width: 100%; max-width: 100%; margin: 0; padding: 0; }
        }
    </style>
</head>
<body>

<nav class="no-print">
    <div class="nav-item active" id="btn-reg" onclick="showTab('register')">1. ê³ ê°ì ‘ìˆ˜</div>
    <div class="nav-item" id="btn-con" onclick="showTab('consult')">2. ì „ë¬¸ìƒë‹´</div>
</nav>

<div class="container">
    <section id="register" class="view-section active">
        <div class="card">
            <h2>ê³ ê° ì •ë³´ ë° ì‚¬ì£¼ ì…ë ¥</h2>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="name" placeholder="ì„±í•¨">
                <select id="gender" style="flex:0.4;"><option value="ì—¬">ì—¬ì„±</option><option value="ë‚¨">ë‚¨ì„±</option></select>
            </div>
            <input type="tel" id="phone" placeholder="ì „í™”ë²ˆí˜¸">
            <input type="text" id="saju_ko" placeholder="ì‚¬ì£¼ 8ê¸€ì (ì˜ˆ: ì‹ í•´ ê¸°í•´ ì„ì¸ ê¸°ìœ )">
            
            <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">
            <h2>ìƒíƒœ ë¬¸ì§„</h2>
            <select id="mainSymptom"><option value="">ê°€ì¥ ë¶ˆí¸í•œ ê³³ ì„ íƒ</option><option>ì–´ê¹¨/ëª© ê²°ë¦¼</option><option>í—ˆë¦¬/ê³¨ë°˜</option><option>ë³µë¶€/ì†Œí™”</option><option>ë‹¤ë¦¬ ë¶“ê¸°</option><option>ì†ë°œ ëƒ‰ì¦</option><option>ìˆ˜ë©´/í”¼ë¡œ</option></select>
            <select id="coldHeat"><option value="">í‰ì†Œ ì˜¨ë„ê° ì„ íƒ</option><option>ì†ë°œì´ ì°¨ë‹¤</option><option>ìƒì²´ ì—´ì´ ë§ë‹¤</option><option>ëƒ‰/ì—´ êµì°¨</option><option>ë³´í†µ</option></select>
            
            <button class="btn btn-blue" onclick="saveCustomer()">ë°ì´í„° ì „ì†¡ ì™„ë£Œ</button>
        </div>
    </section>

    <section id="consult" class="view-section">
        <div class="card no-print">
            <h2>ëŒ€ê¸° ê³ ê° ëª©ë¡</h2>
            <div id="recent-list"></div>
        </div>

        <div id="consult-area" style="display:none;">
            <div class="card no-print">
                <h2 id="targetDisplay">ë¶„ì„ ì§€í‘œ ì…ë ¥</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="number" id="weight" placeholder="ì²´ì¤‘(kg)">
                    <input type="number" id="phaseAngle" placeholder="ìœ„ìƒê°(Â°)">
                    <input type="number" id="fatPct" placeholder="ì²´ì§€ë°©ë¥ (%)">
                    <input type="number" id="water" placeholder="ì²´ìˆ˜ë¶„(L)">
                </div>
                <button class="btn btn-blue" onclick="generateReport()">í†µí•© ë¶„ì„ ë¦¬í¬íŠ¸ ë°œí–‰</button>
            </div>

            <div id="final-report" class="result-box">
                <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 30px;">
                    <h1 style="margin:0; font-size: 26px;">ì²œì¼ë„+ ì²´ì§ˆ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
                    <p id="res-info" style="font-size: 16px; margin-top: 10px; font-weight: bold;"></p>
                </div>

                <div class="saju-grid" id="saju-display"></div>
                <div id="graph-area" style="padding: 10px 20px;"></div>

                <div id="health-ment" class="health-tip"></div>
                <div id="res-code" class="code-tag"></div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin: 20px 0;">
                    <div style="background:#fff5eb; padding:18px; border-radius:12px; border:1px solid #fbd38d;"><strong>ğŸµ ì›°ì»´ ë¶€ìŠ¤í„°</strong><br><span id="res-tea"></span></div>
                    <div style="background:#fffbe6; padding:18px; border-radius:12px; border:1px solid #ffe58f;"><strong>ğŸ”® ë§ˆìŒ ìŠµê´€</strong><br><span id="res-mind"></span></div>
                </div>

                <div class="atomy-box">
                    <strong style="color:var(--í™”);">ğŸ’Š ì˜¤í–‰ ë§ì¶¤ ì• í„°ë¯¸ ì˜ì–‘ ì²˜ë°©</strong><br>
                    <span id="res-atomy" style="font-size: 17px; font-weight: 600; display: block; margin-top: 5px;"></span>
                </div>

                <div style="background: #f1f4f9; padding:18px; border-radius:12px; border:1px solid #ddd; margin-top:20px;">
                    <strong>ğŸ’¡ ì›ì¥ë‹˜ ì „ë¬¸ ì§„ë‹¨</strong><br><span id="res-ment"></span>
                </div>

                <div style="text-align:center; margin-top:40px; font-weight:bold; font-size: 18px;">"ì²´ì˜¨ 1ë„ê°€ ë‹¹ì‹ ì˜ ìš´ëª…ì„ ë°”ê¿‰ë‹ˆë‹¤."</div>
                <button class="btn no-print" onclick="window.print()" style="margin-top:20px; background:#95a5a6; color:white; padding:12px; border-radius:8px; width:100%; border:none; cursor:pointer;">ğŸ–¨ï¸ ë¦¬í¬íŠ¸ ì¸ì‡„</button>
            </div>
        </div>
    </section>
</div>

<script>
    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = { apiKey: "AIzaSyAUucRqU8nciqkINbjZcUUHx3UkR_OOprs", authDomain: "cheon1do-plus.firebaseapp.com", projectId: "cheon1do-plus", storageBucket: "cheon1do-plus.firebasestorage.app", messagingSenderId: "344900999016", appId: "1:344900999016:web:a20ef3b01df68ca03928dd" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // í™•ì‹¤í•œ íƒ­ ì „í™˜ ê¸°ëŠ¥
    function showTab(name) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(name).classList.add('active');
        document.getElementById(name === 'register' ? 'btn-reg' : 'btn-con').classList.add('active');
        if(name === 'consult') loadRecentCustomers();
    }

    // ì „ì†¡ ì™„ë£Œ íŒì—… í¬í•¨ ì €ì¥ ê¸°ëŠ¥
    async function saveCustomer() {
        const name = document.getElementById('name').value;
        const saju = document.getElementById('saju_ko').value;
        if(!name || !saju) return alert("ì„±í•¨ê³¼ ì‚¬ì£¼ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        
        const data = {
            name, gender: document.getElementById('gender').value,
            phone: document.getElementById('phone').value,
            saju_ko: saju,
            survey: { mainSymptom: document.getElementById('mainSymptom').value, coldHeat: document.getElementById('coldHeat').value },
            createdAt: new Date()
        };
        
        await db.collection("clients").add(data);
        alert("âœ… " + name + "ë‹˜ ì ‘ìˆ˜ ì™„ë£Œ! [ì „ë¬¸ìƒë‹´] íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.");
        showTab('consult');
    }

    async function loadRecentCustomers() {
        const snap = await db.collection("clients").orderBy("createdAt", "desc").limit(10).get();
        const listDiv = document.getElementById('recent-list');
        listDiv.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            const time = d.createdAt ? d.createdAt.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
            const btn = document.createElement('button');
            btn.className = "btn-list";
            btn.innerHTML = `<span>${d.name}(${d.gender})</span> <span>${time} ì ‘ìˆ˜</span>`;
            btn.onclick = () => { 
                window.currentC = d; 
                document.getElementById('consult-area').style.display='block';
                document.getElementById('final-report').style.display='none';
                document.getElementById('targetDisplay').innerText = d.name + " ë‹˜ ì¸ë°”ë”” ì…ë ¥";
            };
            listDiv.appendChild(btn);
        });
    }

    const sajuMap = { 'ì‹ ':'è¾›','í•´':'äº¥','ê¸°':'å·±','ì„':'å£¬','ì¸':'å¯…','ìœ ':'é…‰','ì':'å­','ì¶•':'ä¸‘','ë³‘':'ä¸™','ì •':'ä¸','ë¬´':'æˆŠ','ê²½':'åºš','ì„':'ä¹™','ê°‘':'ç”²','ê³„':'ç™¸','ë¯¸':'æœª','ìˆ ':'æˆŒ','ì§„':'è¾°','ì‚¬':'å·³','ì˜¤':'åˆ','ë¬˜':'å¯' };
    const sajuColor = { 'è¾›':'ê¸ˆ','åºš':'ê¸ˆ','é…‰':'ê¸ˆ','ç”³':'ê¸ˆ','å£¬':'ìˆ˜','ç™¸':'ìˆ˜','äº¥':'ìˆ˜','å­':'ìˆ˜','ç”²':'ëª©','ä¹™':'ëª©','å¯…':'ëª©','å¯':'ëª©','ä¸™':'í™”','ä¸':'í™”','å·³':'í™”','åˆ':'í™”','æˆŠ':'í† ','å·±':'í† ','è¾°':'í† ','æˆŒ':'í† ','ä¸‘':'í† ','æœª':'í† ' };

    function generateReport() {
        const d = window.currentC;
        const hanjas = d.saju_ko.split(' ').map(k => sajuMap[k] || k);
        const counts = { 'ëª©':0, 'í™”':0, 'í† ':0, 'ê¸ˆ':0, 'ìˆ˜':0 };
        hanjas.forEach(h => { if(sajuColor[h]) counts[sajuColor[h]]++; });

        // ì‚¬ì£¼ ì¹´ë“œ ë Œë”ë§
        const labels = ['ì‹œì£¼','ì¼ì£¼','ì›”ì£¼','ë…„ì£¼'];
        document.getElementById('saju-display').innerHTML = labels.map((l, i) => `
            <div class="saju-box">
                <div class="saju-label">${l}</div>
                <div class="saju-char" style="color:var(--${sajuColor[hanjas[i*2]]})">${hanjas[i*2] || '-'}</div>
                <div class="saju-char" style="color:var(--${sajuColor[hanjas[i*2+1]]})">${hanjas[i*2+1] || '-'}</div>
            </div>`).join('');

        // ì˜¤í–‰ ê·¸ë˜í”„ ë Œë”ë§
        document.getElementById('graph-area').innerHTML = Object.entries(counts).map(([name, count]) => {
            const pct = (count/8)*100;
            return `<div class="graph-row">
                <div class="graph-label"><span>${name}(${name === 'ëª©'?'æœ¨':name === 'í™”'?'ç«':name === 'í† '?'åœŸ':name === 'ê¸ˆ'?'é‡‘':'æ°´'})</span><span>${Math.round(pct)}%</span></div>
                <div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:var(--${name})"></div></div>
            </div>`;
        }).join('');

        const maxGi = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        let hMent = "", pRec = "", mind = "";
        
        if(maxGi === 'ìˆ˜') { 
            hMent = "ğŸ’§ <b>ìˆ˜(æ°´) ê¸°ìš´ ê³¼ë‹¤:</b> ì‹ ì¥ê³¼ í•˜ì²´ ìˆœí™˜ì´ ì•½í•´ì§€ê¸° ì‰¬ìš°ë©° ëª¸ì´ ì°¨ê³  ë¶“ëŠ” ìˆ˜ë… ì •ì²´ë¥¼ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤. ì‹¬ë¶€ ì˜¨ë„ë¥¼ ë†’ì´ëŠ” ê²ƒì´ ìµœìš°ì„ ì…ë‹ˆë‹¤."; 
            pRec = "í—¤ëª¨í˜, í™ì‚¼ë‹¨, ë³´ì´ì°¨, ìœ ì‚°ê· ";
            mind = "í˜¼ì ì°¸ì§€ ë§ˆì„¸ìš”. ê³ ë¯¼ì„ ë•€ê³¼ í•¨ê»˜ ë°°ì¶œí•  ë•Œ ìš´ì´ ì—´ë¦½ë‹ˆë‹¤.";
        } else if(maxGi === 'í™”') { 
            hMent = "ğŸ”¥ <b>í™”(ç«) ê¸°ìš´ ê³¼ë‹¤:</b> ì‹¬ì¥ ì—´ê°ì´ ìœ„ë¡œ ì˜¬ë¼ì™€ ê°€ìŠ´ ë‹µë‹µí•¨ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒê¸°ë˜ëŠ” ì—´ì„ ë‚´ë¦¬ëŠ” ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤."; 
            pRec = "ì˜¤ë©”ê°€3, ë½í‹°ì›€, ì¹¼ë§ˆë””";
            mind = "ì¡°ê¸‰í•¨ì„ ë‚´ë ¤ë†“ìœ¼ì„¸ìš”. ì²œì²œíˆ í˜¸í¡í•˜ëŠ” ìŠµê´€ì´ ë³´ì•½ì…ë‹ˆë‹¤.";
        } else if(maxGi === 'í† ') { 
            hMent = "â›°ï¸ <b>í† (åœŸ) ê¸°ìš´ ê³¼ë‹¤:</b> ê¸°í˜ˆ ì •ì²´ê°€ ì‰½ê²Œ ì¼ì–´ë‚˜ ì†Œí™” ë¶ˆëŸ‰ì´ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìœ„ì¥ ìš´ë™ì„ ë•ëŠ” ê´€ë¦¬ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤."; 
            pRec = "íŒŒì¸ìì„, ìœ ì‚°ê· , ì°¨ì „ìí”¼";
            mind = "ì™„ë²½í•˜ë ¤ëŠ” ìƒê°ì„ ë¹„ìš°ì„¸ìš”. ë‡Œê°€ ì‰¬ì–´ì•¼ ìœ„ì¥ë„ ì›€ì§ì…ë‹ˆë‹¤.";
        } else if(maxGi === 'ëª©') { 
            hMent = "ğŸŒ³ <b>ëª©(æœ¨) ê¸°ìš´ ê³¼ë‹¤:</b> ê°„ ê¸°ìš´ì´ ë­‰ì³ ê·¼ìœ¡ì´ ë”±ë”±í•´ì§€ê¸° ì‰½ìŠµë‹ˆë‹¤. í•´ë…ê³¼ ê·¼ìœ¡ ì´ì™„ì´ í•µì‹¬ì…ë‹ˆë‹¤."; 
            pRec = "ë°€í¬ì”¨ìŠ¬, ë¹„íƒ€ë¯¼B ì»´í”Œë ‰ìŠ¤";
            mind = "ì±…ì„ê°ì„ ì ì‹œ ë‚´ë ¤ë†“ìœ¼ì„¸ìš”. ì–´ê¹¨ì˜ ì§ì„ ëœì–´ì•¼ ë³µì´ ë“¤ì–´ì˜µë‹ˆë‹¤.";
        } else { 
            hMent = "âš”ï¸ <b>ê¸ˆ(é‡‘) ê¸°ìš´ ê³¼ë‹¤:</b> í˜¸í¡ê¸°ì™€ í”¼ë¶€ ê±´ì¡°ë¥¼ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤. ë©´ì—­ë ¥ì„ ë†’ì—¬ ê¸°ê´€ì§€ë¥¼ ë³´í˜¸í•˜ì„¸ìš”."; 
            pRec = "ë…¸ë‹ˆ, ë¹„íƒ€ë¯¼C, ë£¨í…Œì¸";
            mind = "ì˜ˆë¯¼í•œ ë§ˆìŒì„ ë‹¤ë…ì´ì„¸ìš”. ë‚´ë©´ì˜ ì¤‘ì‹¬ì„ ì„¸ìš°ëŠ” ê²ƒì´ ê±´ê°•ì˜ ì‹œì‘ì…ë‹ˆë‹¤.";
        }

        document.getElementById('res-info').innerText = `${d.name} (${d.gender}) / ${d.phone || 'ë²ˆí˜¸ë¯¸ì…ë ¥'}`;
        document.getElementById('health-ment').innerHTML = hMent;
        document.getElementById('res-atomy').innerText = pRec;
        document.getElementById('res-code').innerText = maxGi === 'ìˆ˜' ? "S3R ìˆœí™˜ì •ì²´í˜• (ì²´ì§ˆë¶€ì¢…)" : "ì˜¤í–‰ ë°¸ëŸ°ìŠ¤ ì¡°ì •í˜•";
        document.getElementById('res-tea').innerText = "ê¸°í˜ˆ ìˆœí™˜ì„ ë•ëŠ” í™ì‚¼ë‹¨ ì˜¨ìˆ˜ ì²˜ë°©";
        document.getElementById('res-mind').innerText = mind;
        document.getElementById('res-ment').innerText = `ìœ„ìƒê° ${document.getElementById('phaseAngle').value}Â° ì§„ë‹¨ ê²°ê³¼, ê¾¸ì¤€í•œ ì˜¨ì—´ ê´€ë¦¬ê°€ ì‹œê¸‰í•©ë‹ˆë‹¤.`;
        document.getElementById('final-report').style.display = 'block';
    }
</script>
</body>
</html>
