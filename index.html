<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>체온1도씨플러스 상담앱</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { margin: 0; background: #f1f5f9; }
      input, textarea, select, button { font-family: system-ui, sans-serif; }
      button { cursor: pointer; }
      @media print {
        body { background: white; }
        .no-print { display: none !important; }
        .click-card:hover { background:#fff7ed; border-color:#fdba74 !important; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      // 1. 파이어베이스 설정 (새로 발급받은 안전한 키 적용)
      const firebaseConfig = {
        apiKey: "AIzaSyAUucRqU8nciqkINbjZcUUHx3UkR_OOprs",
        authDomain: "cheon1do-plus.firebaseapp.com",
        projectId: "cheon1do-plus",
        storageBucket: "cheon1do-plus.firebasestorage.app",
        messagingSenderId: "344900999016",
        appId: "1:344900999016:web:a20ef3b01df68ca03928dd",
        measurementId: "G-MWCH1M7B33"
      };

      // --- [사주 데이터 및 상수 설정] ---
      const STEM_KOR_TO_HANJA = { 갑:"甲", 을:"乙", 병:"丙", 정:"丁", 무:"戊", 기:"己", 경:"庚", 신:"辛", 임:"壬", 계:"癸" };
      const BRANCH_KOR_TO_HANJA = { 자:"子", 축:"丑", 인:"寅", 묘:"卯", 진:"辰", 사:"巳", 오:"午", 미:"未", 신:"申", 유:"酉", 술:"戌", 해:"亥" };
      const STEM_EL = { 甲:"wood",乙:"wood",丙:"fire",丁:"fire",戊:"earth",己:"earth",庚:"metal",辛:"metal",壬:"water",癸:"water" };
      const BRANCH_EL = { 子:"water",亥:"water",寅:"wood",卯:"wood",巳:"fire",午:"fire",辰:"earth",戌:"earth",丑:"earth",未:"earth",申:"metal",酉:"metal" };

      const EL_LABEL = { wood:"목(木)", fire:"화(火)", earth:"토(土)", metal:"금(金)", water:"수(水)" };
      const EL_COLOR = { wood:"#16a34a", fire:"#dc2626", earth:"#a16207", metal:"#64748b", water:"#2563eb" };
      const PRICE_TABLE = {
        trial: { label:"1회 체험", price: 70000 },
        w4: { label:"4주 11회", price: 800000 },
        w8: { label:"8주 집중", price: 1500000 },
        w12: { label:"12주 완성", price: 2000000 },
      };

      const RECO = {
        wood: { programName:"간·순환 리커버리", diet:["녹색채소","신맛 소량","야식 줄이기"], exercise:["스트레칭","요가","걷기"], heatDome:["주 3회 35~40분","복부·골반 집중"], atomy:["헤모힘","오메가3"] },
        fire: { programName:"심장·수면 밸런스", diet:["토마토","카페인 줄이기","매운맛 줄이기"], exercise:["빠른 걷기","호흡 명상","가벼운 유산소"], heatDome:["주 2~3회 30~35분","저온부터 점진"], atomy:["비타민C","칼마디"] },
        earth: { programName:"장·대사 리셋", diet:["따뜻한 음식","식이섬유","밀가루 줄이기"], exercise:["식후 걷기","스쿼트","코어"], heatDome:["주 3회 35분","복부 순환"], atomy:["프로바이오틱스","비타민B"] },
        metal: { programName:"폐·피부 디톡스", diet:["배/무","수분섭취","흡연 줄이기"], exercise:["호흡운동","가벼운 근력","걷기"], heatDome:["주 2~3회 30분","등·견갑부 중심"], atomy:["프로폴리스","비타민C"] },
        water: { programName:"신장·부종 순환", diet:["검은콩","저염식","야식 금지"], exercise:["하체 강화","골반 스트레칭","걷기"], heatDome:["주 3회 40분","하복부·허리 중심"], atomy:["홍삼","비타민B"] },
      };

      const INBODY_KEYS = { weight:"체중(kg)", muscle:"근육량(kg)", water:"체수분(L)", fatKg:"체지방량(kg)", fatPct:"체지방률(%)", phaseAngle:"위상각(°)" };

      const QUESTIONS = [
        { key:"mainSymptom", label:"어디가 가장 불편하신가요?", options:["선택", "어깨/목 결림", "허리/골반", "복부/소화", "다리 붓기", "손발 냉증", "수면/피로"] },
        { key:"coldHeat", label:"몸의 온도 느낌은 어떤가요?", options:["선택", "손발이 차다", "상체 열이 많다", "냉/열이 번갈아 있다", "보통"] },
        { key:"digestion", label:"식후 상태는 어떤가요?", options:["선택", "속이 더부룩하다", "가스/트림이 잦다", "식곤증이 심하다", "큰 불편 없음"] },
        { key:"sleep", label:"수면은 어떤 편인가요?", options:["선택", "잠들기 어렵다", "자주 깬다", "자고 나도 피곤", "수면 양호"] },
        { key:"stress", label:"스트레스/피로도는 어떤가요?", options:["선택", "매우 높다", "높다", "보통", "낮다"] },
      ];

      const OPTION_TO_ELEMENT = {
        mainSymptom: { "어깨/목 결림":"wood", "허리/골반":"water", "복부/소화":"earth", "다리 붓기":"water", "손발 냉증":"fire", "수면/피로":"fire" },
        coldHeat: { "손발이 차다":"fire", "상체 열이 많다":"water", "냉/열이 번갈아 있다":"water", "보통":"earth" },
        digestion: { "속이 더부룩하다":"earth", "가스/트림이 잦다":"earth", "식곤증이 심하다":"earth", "큰 불편 없음":"metal" },
        sleep: { "잠들기 어렵다":"fire", "자주 깬다":"fire", "자고 나도 피곤":"water", "수면 양호":"wood" },
        stress: { "매우 높다":"wood", "높다":"wood", "보통":"earth", "낮다":"metal" }
      };

      const ATOMY_BY_ISSUE = { cold: "홍삼", edema: "칼륨/미네랄 밸런스 제품", highFat: "오메가3", lowPhase: "헤모힘", digestion: "프로바이오틱스", stress: "비타민B" };

      const CONSTITUTION_CODE_BOOK = {
        S3R: { title:"수정체 순환형", feature:["다리 붓기", "오후 붓기 심화"], prescription:["온열 30분", "웨이브 20분", "종아리 수축 운동"], supplements:["애터미 오메가3", "애터미 헤모힘"], ment:"순환을 돌리면서 혈관 흐름을 같이 올립니다." },
        H2M: { title:"화부족 저대사형", feature:["체온 낮음", "체지방 감량 반응 저하"], prescription:["온열 40분", "웨이브 15분", "스텝 3분"], supplements:["애터미 B컴플렉스", "애터미 프로바이오틱스"], ment:"대사를 먼저 올려야 체지방이 반응합니다." },
        T3M: { title:"토정체 소화형", feature:["가스/트림", "더부룩함"], prescription:["복부 온열 30분", "웨이브 15분"], supplements:["애터미 프로바이오틱스", "애터미 식이섬유 제품"], ment:"소화가 풀려야 붓기도 줄어듭니다." },
        W1N: { title:"목과다 긴장형", feature:["불면", "예민/긴장"], prescription:["온열 40분(저강도)", "복식호흡"], supplements:["애터미 칼마디", "애터미 B컴플렉스"], ment:"신경을 안정시키는 방향으로 갑니다." },
        M2R: { title:"금허 면역형", feature:["면역 저하", "피부 건조/호흡기 민감"], prescription:["온열 35분", "웨이브 15분"], supplements:["애터미 헤모힘", "애터미 비타민C"], ment:"면역을 올려야 회복속도가 빨라집니다." },
        ST4R: { title:"수+토 복합정체형", feature:["붓기 + 소화불량 동시"], prescription:["온열 30분", "웨이브 20분", "가벼운 걷기"], supplements:["애터미 프로바이오틱스", "애터미 오메가3", "애터미 헤모힘"], ment:"장과 혈관을 같이 돌립니다." },
        T2C: { title:"토허 근감소형", feature:["근육량 저하", "피로 누적"], prescription:["온열 30분", "웨이브 20분", "하체 근력"], supplements:["애터미 단백질 제품", "애터미 칼마디"], ment:"근육이 늘어야 기초대사가 유지됩니다." },
        S2C: { title:"수허 냉증형", feature:["손발 냉증", "허리 시림"], prescription:["온열 40분", "저강도 걷기"], supplements:["애터미 B컴플렉스", "애터미 오메가3"], ment:"속체온을 유지하는 방향으로 갑니다." }
      };

      // --- [분석 함수 로직] ---
      function parseSajuKor(raw) {
        const parts = raw.trim().split(/\s+/).filter(Boolean);
        if (parts.length !== 4) return { ok:false, error:"사주는 4개(년 월 일 시) 입력 예: 신해 기해 임인 기유" };
        const parsed = parts.map((pair) => {
          if (pair.length !== 2) return null;
          const stemKor = pair[0], branchKor = pair[1];
          const stem = STEM_KOR_TO_HANJA[stemKor];
          const branch = BRANCH_KOR_TO_HANJA[branchKor];
          if (!stem || !branch) return null;
          return { stemKor, branchKor, stem, branch, stemEl: STEM_EL[stem], branchEl: BRANCH_EL[branch] };
        });
        if (parsed.some((x) => !x)) return { ok:false, error:"천간/지지 입력을 확인해주세요." };
        return { ok:true, value: parsed };
      }

      function countElements(parsed) {
        const c = { wood:0, fire:0, earth:0, metal:0, water:0 };
        parsed.forEach((p) => { c[p.stemEl] += 1; c[p.branchEl] += 1; });
        return c;
      }

      function pickProgram(inbody) {
        if (!inbody) return PRICE_TABLE.w4;
        if (Number(inbody.phaseAngle) < 5 && Number(inbody.phaseAngle) > 0) return PRICE_TABLE.w12;
        if (Number(inbody.fatPct) >= 30) return PRICE_TABLE.w8;
        return PRICE_TABLE.w4;
      }

      function analyzeSurvey(questionnaire) {
        const score = { wood:0, fire:0, earth:0, metal:0, water:0 };
        const points = [];
        Object.keys(questionnaire).forEach((key) => {
          const ans = questionnaire[key];
          const el = OPTION_TO_ELEMENT[key]?.[ans];
          if (el) score[el] += 1;
        });
        const max = Math.max(...Object.values(score));
        const target = Object.keys(score).find((k)=>score[k]===max) || "earth";
        if (["손발이 차다", "자고 나도 피곤"].includes(questionnaire.coldHeat) || questionnaire.mainSymptom === "손발 냉증") points.push("체온 저하·말초순환 저하 신호가 있어 온열 관리 강도를 높이세요.");
        if (["속이 더부룩하다", "가스/트림이 잦다", "식곤증이 심하다"].includes(questionnaire.digestion)) points.push("소화기 부담이 있어 식사량 분할·야식 제한이 필요합니다.");
        if (["매우 높다", "높다"].includes(questionnaire.stress)) points.push("스트레스 축이 높아 혈압/혈당 변동 관리가 중요합니다.");
        return { score, target, points };
      }

      function analyzeInbody(inbody, useInbody) {
        if (!useInbody) return { used:false, risks:[], points:["인바디 데이터 없이 사주/문진 기반 분석"], target:"earth" };
        const risks = []; const points = []; let target = "earth";
        const fatPct = Number(inbody.fatPct || 0); const phase = Number(inbody.phaseAngle || 0);
        if (fatPct >= 30) { risks.push("highFat"); points.push(`체지방률 ${fatPct}%로 대사 저하 위험이 있습니다.`); target = "earth"; }
        if (phase > 0 && phase < 5) { risks.push("lowPhase"); points.push(`위상각 ${phase}°로 세포 활력 저하 신호가 있습니다.`); target = "water"; }
        return { used:true, risks, points, target };
      }

      function deriveConstitutionCode({ counts, questionnaire, inbody }) {
        const isEdema = questionnaire.mainSymptom === "다리 붓기" || counts.water >= 3;
        const isDigestion = ["속이 더부룩하다", "가스/트림이 잦다"].includes(questionnaire.digestion);
        let code = "H2M";
        if (isEdema && isDigestion) code = "ST4R";
        else if (isEdema) code = "S3R";
        else if (isDigestion) code = "T3M";
        const profile = CONSTITUTION_CODE_BOOK[code] || CONSTITUTION_CODE_BOOK.H2M;
        return { code, profile, inbodySummary: inbody ? "인바디 반영됨" : "미측정" };
      }

      function buildOhengComment(parsed, counts, surveyAnalysis, inbodyAnalysis, questionnaire, inbody) {
        const [year, month, day, hour] = parsed;
        const entries = Object.entries(counts);
        const max = Math.max(...entries.map(([,v]) => v));
        const min = Math.min(...entries.map(([,v]) => v));
        const strong = entries.filter(([,v]) => v === max).map(([k]) => k);
        const weak = entries.filter(([,v]) => v === min).map(([k]) => k);
        
        return {
          weak, strong,
          sajuSummary: `사주: ${year.stemKor}${year.branchKor}년 · ${month.stemKor}${month.branchKor}월 · ${day.stemKor}${day.branchKor}일 · ${hour.stemKor}${hour.branchKor}시`,
          sections: [
            { title: "1) 핵심 구조", items: [ `일간: ${day.stem}(${day.stemKor})`, `강한 오행: ${strong.map(k=>EL_LABEL[k]).join(", ")}`, `약한 오행: ${weak.map(k=>EL_LABEL[k]).join(", ")}` ] },
            { title: "2) 문진 포인트", items: surveyAnalysis.points.length ? surveyAnalysis.points : ["특이사항 없음"] },
            { title: "3) 인바디 분석", items: inbodyAnalysis.points }
          ],
          primaryTarget: surveyAnalysis.target
        };
      }

      function getPillarCards(parsed) {
        const [y, m, d, h] = parsed;
        return [
          { title:"시주", top:h.stem, topEl:h.stemEl, topSub:"시간", bottom:h.branch, bottomEl:h.branchEl, bottomSub:"시지" },
          { title:"일주", top:d.stem, topEl:d.stemEl, topSub:"일간", bottom:d.branch, bottomEl:d.branchEl, bottomSub:"일지" },
          { title:"월주", top:m.stem, topEl:m.stemEl, topSub:"월간", bottom:m.branch, bottomEl:m.branchEl, bottomSub:"월지" },
          { title:"년주", top:y.stem, topEl:y.stemEl, topSub:"년간", bottom:y.branch, bottomEl:y.branchEl, bottomSub:"년지" },
        ];
      }

      // --- [에러 바운더리] ---
      class AppErrorBoundary extends React.Component {
        constructor(props) { super(props); this.state = { hasError:false }; }
        static getDerivedStateFromError() { return { hasError:true }; }
        render() {
          if (this.state.hasError) return <div style={{padding:20}}><h2>앱 화면 오류가 발생했습니다. 새로고침 해주세요.</h2></div>;
          return this.props.children;
        }
      }

      // --- [메인 앱 컴포넌트] ---
      function App() {
        const [view, setView] = useState("form");
        const [step, setStep] = useState(1);
        const [name, setName] = useState("");
        const [phone, setPhone] = useState("");
        const [sajuRaw, setSajuRaw] = useState("");
        const [questionnaire, setQuestionnaire] = useState({ mainSymptom:"", coldHeat:"", digestion:"", sleep:"", stress:"" });
        const [useInbody, setUseInbody] = useState(true);
        const [inbody, setInbody] = useState({ weight:"", muscle:"", water:"", fatKg:"", fatPct:"", phaseAngle:"" });
        const [customers, setCustomers] = useState([]);

        useEffect(() => {
          const saved = localStorage.getItem("assessments-local");
          if (saved) setCustomers(JSON.parse(saved));
        }, []);

        const parsedRes = useMemo(() => parseSajuKor(sajuRaw), [sajuRaw]);
        const result = useMemo(() => {
          if (!parsedRes.ok) return null;
          const parsed = parsedRes.value;
          const counts = countElements(parsed);
          const sAnalysis = analyzeSurvey(questionnaire);
          const iAnalysis = analyzeInbody(inbody, useInbody);
          const oComment = buildOhengComment(parsed, counts, sAnalysis, iAnalysis, questionnaire, inbody);
          const codePack = deriveConstitutionCode({ counts, questionnaire, inbody: useInbody ? inbody : null });
          const baseReco = RECO[oComment.primaryTarget] || RECO.earth;
          
          return { parsed, counts, ohengComment: oComment, codePack, program: { title: baseReco.programName, recommend: pickProgram(useInbody?inbody:null) }, heatDome: baseReco.heatDome, atomy: baseReco.atomy, inbodyAnalysis: iAnalysis };
        }, [parsedRes, questionnaire, inbody, useInbody]);

        const saveCustomer = () => {
          const next = [{ id: Date.now(), name, phone, result, date: new Date().toLocaleString() }, ...customers];
          setCustomers(next);
          localStorage.setItem("assessments-local", JSON.stringify(next));
          alert("저장되었습니다.");
        };

        return (
          <div style={{maxWidth:960, margin:"0 auto", padding:16}}>
            <h1 style={{fontSize:28, fontWeight:900}}>체온1도씨플러스 상담앱</h1>
            <div className="no-print" style={{display:"flex", gap:8, marginBottom:20}}>
              <button onClick={()=>{setView("form"); setStep(1);}} style={{padding:"8px 16px", background:view==="form"?"#0f172a":"#e2e8f0", color:view==="form"?"white":"black", borderRadius:20, border:"none"}}>신규 상담</button>
              <button onClick={()=>setView("list")} style={{padding:"8px 16px", background:view==="list"?"#0f172a":"#e2e8f0", color:view==="list"?"white":"black", borderRadius:20, border:"none"}}>목록 ({customers.length})</button>
            </div>

            {view === "form" && (
              <>
                {step === 1 && (
                  <div style={{background:"white", padding:20, borderRadius:16, border:"1px solid #e2e8f0"}}>
                    <h2>고객 정보 및 사주</h2>
                    <div style={{display:"flex", gap:10, marginBottom:10}}>
                      <input placeholder="이름" value={name} onChange={e=>setName(e.target.value)} style={{flex:1, padding:12, borderRadius:8, border:"1px solid #cbd5e1"}}/>
                      <input placeholder="전화번호" value={phone} onChange={e=>setPhone(e.target.value)} style={{flex:1, padding:12, borderRadius:8, border:"1px solid #cbd5e1"}}/>
                    </div>
                    <input placeholder="사주 (예: 신해 기해 임인 기유)" value={sajuRaw} onChange={e=>setSajuRaw(e.target.value)} style={{width:"100%", padding:12, borderRadius:8, border:"1px solid #cbd5e1", marginBottom:20}}/>
                    <h3>문진</h3>
                    {QUESTIONS.map(q => (
                      <div key={q.key} style={{marginBottom:10}}>
                        <div style={{fontWeight:600}}>{q.label}</div>
                        <select value={questionnaire[q.key]} onChange={e=>setQuestionnaire({...questionnaire, [q.key]:e.target.value})} style={{width:"100%", padding:10, borderRadius:8}}>
                          {q.options.map(o => <option key={o} value={o}>{o}</option>)}
                        </select>
                      </div>
                    ))}
                    <button onClick={()=>setStep(2)} style={{width:"100%", padding:15, background:"#16a34a", color:"white", border:"none", borderRadius:10, fontWeight:700, marginTop:10}}>다음 단계</button>
                  </div>
                )}
                {step === 2 && (
                  <div style={{background:"white", padding:20, borderRadius:16, border:"1px solid #e2e8f0"}}>
                    <h2>인바디 정보</h2>
                    <div style={{display:"grid", gridTemplateColumns:"1fr 1fr", gap:10}}>
                      {Object.keys(INBODY_KEYS).map(k => (
                        <input key={k} type="number" placeholder={INBODY_KEYS[k]} value={inbody[k]} onChange={e=>setInbody({...inbody, [k]:e.target.value})} style={{padding:12, borderRadius:8, border:"1px solid #cbd5e1"}}/>
                      ))}
                    </div>
                    <button onClick={()=>setStep(3)} style={{width:"100%", padding:15, background:"#16a34a", color:"white", border:"none", borderRadius:10, fontWeight:700, marginTop:20}}>결과 보기</button>
                  </div>
                )}
                {step === 3 && result && (
                  <div style={{background:"white", padding:20, borderRadius:16, border:"1px solid #e2e8f0"}}>
                    <h2>상담 리포트: {name}님</h2>
                    <div style={{display:"grid", gridTemplateColumns:"repeat(4,1fr)", gap:10, marginBottom:20}}>
                      {getPillarCards(result.parsed).map(c => (
                        <div key={c.title} style={{textAlign:"center", border:"1px solid #eee", padding:10, borderRadius:10}}>
                          <div style={{fontSize:12, color:"#666"}}>{c.title}</div>
                          <div style={{fontSize:24, fontWeight:900, color:EL_COLOR[c.topEl]}}>{c.top}</div>
                          <div style={{fontSize:24, fontWeight:900, color:EL_COLOR[c.bottomEl]}}>{c.bottom}</div>
                        </div>
                      ))}
                    </div>
                    {result.ohengComment.sections.map(s => (
                      <div key={s.title} style={{marginBottom:15, padding:10, background:"#f8fafc", borderRadius:10}}>
                        <div style={{fontWeight:800, color:"#1e293b"}}>{s.title}</div>
                        <div>{s.items.join(" / ")}</div>
                      </div>
                    ))}
                    <div style={{background:"#0f172a", color:"white", padding:15, borderRadius:10}}>
                      <b>추천 프로그램: {result.program.title}</b> ({result.program.recommend.label})
                    </div>
                    <div style={{marginTop:20, display:"flex", gap:10}} className="no-print">
                      <button onClick={()=>window.print()} style={{flex:1, padding:12}}>인쇄하기</button>
                      <button onClick={saveCustomer} style={{flex:1, padding:12, background:"#16a34a", color:"white", border:"none", borderRadius:10}}>저장하기</button>
                    </div>
                  </div>
                )}
              </>
            )}

            {view === "list" && (
              <div style={{background:"white", padding:20, borderRadius:16, border:"1px solid #e2e8f0"}}>
                <h2>저장된 상담 기록</h2>
                {customers.map(c => (
                  <div key={c.id} style={{padding:15, borderBottom:"1px solid #eee", display:"flex", justifyContent:"space-between"}}>
                    <div><b>{c.name}</b> ({c.phone}) - {c.date}</div>
                    <button onClick={()=>{setName(c.name); setPhone(c.phone); setSajuRaw(c.result.parsed.map(p=>p.stemKor+p.branchKor).join(" ")); setView("form"); setStep(3);}} style={{padding:"5px 10px"}}>보기</button>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<AppErrorBoundary><App /></AppErrorBoundary>);
    </script>
  </body>
</html>
