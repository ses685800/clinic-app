<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>체온1도씨 v7.0</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;
const { initializeApp } = firebase;
const { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc } = firebase.firestore;

/* ================= Firebase 설정 ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAAGeQ1vJ-guHZSNzsIJ4aUYiTbzVwdAdQ",
  authDomain: "cheon1do-plus.firebaseapp.com",
  projectId: "cheon1do-plus",
  storageBucket: "cheon1do-plus.firebasestorage.app",
  messagingSenderId: "344900999016",
  appId: "1:344900999016:web:a20ef3b01df68ca03928dd",
  measurementId: "G-MWCH1M7B33"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= 오행 기본 ================= */

const STEM_EL = {
  갑:"wood", 을:"wood",
  병:"fire", 정:"fire",
  무:"earth", 기:"earth",
  경:"metal", 신:"metal",
  임:"water", 계:"water"
};

const BRANCH_EL = {
  자:"water", 해:"water",
  인:"wood", 묘:"wood",
  사:"fire", 오:"fire",
  진:"earth", 술:"earth", 축:"earth", 미:"earth",
  신:"metal", 유:"metal"
};

const CODE_MAP = { wood:"W", fire:"H", earth:"T", metal:"M", water:"S" };

/* ================= 앱 ================= */

function App(){

  const [mode,setMode] = useState("front");
  const [name,setName] = useState("");
  const [birth,setBirth] = useState("");
  const [saju,setSaju] = useState("");
  const [clients,setClients] = useState([]);
  const [selected,setSelected] = useState(null);

  const [bodyFat,setBodyFat] = useState("");
  const [muscle,setMuscle] = useState("");
  const [bmr,setBmr] = useState("");
  const [phase,setPhase] = useState("");

  useEffect(()=>{
    const unsub = firebase.firestore()
      .collection("clients")
      .where("status","==","waiting")
      .onSnapshot(snapshot=>{
        const list=[];
        snapshot.forEach(doc=>{
          list.push({id:doc.id,...doc.data()});
        });
        setClients(list);
      });
    return ()=>unsub();
  },[]);

  /* ===== 체질코드 계산 ===== */

  function getCode(){
    if(!saju) return null;
    const counts={wood:0,fire:0,earth:0,metal:0,water:0};
    const chars=saju.split("");
    chars.forEach(c=>{
      if(STEM_EL[c]) counts[STEM_EL[c]]++;
      if(BRANCH_EL[c]) counts[BRANCH_EL[c]]++;
    });
    let weakest="wood"; let min=99;
    Object.keys(counts).forEach(el=>{
      if(counts[el]<min){min=counts[el]; weakest=el;}
    });
    const percent=Math.round((counts[weakest]/8)*100);
    const state = percent <=10 ? 2 : 3;
    return CODE_MAP[weakest] + state + "M";
  }

  async function handleRegister(){
    if(!name || !birth) return alert("정보 입력");
    await firebase.firestore().collection("clients").add({
      name,
      birth,
      status:"waiting",
      createdAt: new Date()
    });
    setName(""); setBirth("");
    alert("접수 완료");
  }

  async function completeConsult(){
    if(!selected) return;
    const code = getCode();
    await firebase.firestore().collection("clients").doc(selected.id).update({
      saju,
      bodyFat,
      muscle,
      bmr,
      phase,
      code,
      status:"complete",
      completedAt: new Date()
    });
    setSelected(null);
    alert("상담 저장 완료");
  }

  return(
    <div className="max-w-4xl mx-auto p-6 space-y-6">

      <div className="flex gap-4">
        <button onClick={()=>setMode("front")}
          className="bg-blue-500 text-white px-4 py-2 rounded">
          접수모드
        </button>
        <button onClick={()=>setMode("consult")}
          className="bg-gray-700 text-white px-4 py-2 rounded">
          상담모드
        </button>
      </div>

      {mode==="front" && (
        <div className="bg-white p-6 rounded shadow space-y-4">
          <h2 className="text-xl font-bold">고객 접수</h2>
          <input placeholder="이름"
            value={name}
            onChange={e=>setName(e.target.value)}
            className="border p-2 w-full rounded"/>
          <input placeholder="생년월일시 (예: 1990-01-01 10:30)"
            value={birth}
            onChange={e=>setBirth(e.target.value)}
            className="border p-2 w-full rounded"/>
          <button onClick={handleRegister}
            className="bg-blue-600 text-white px-4 py-2 rounded">
            접수 저장
          </button>
        </div>
      )}

      {mode==="consult" && (
        <div className="grid md:grid-cols-2 gap-6">

          <div className="bg-white p-4 rounded shadow">
            <h3 className="font-bold mb-2">대기 고객</h3>
            {clients.map(c=>(
              <div key={c.id}
                onClick={()=>setSelected(c)}
                className="p-2 border mb-2 cursor-pointer hover:bg-gray-100">
                {c.name}
              </div>
            ))}
          </div>

          {selected && (
            <div className="bg-white p-4 rounded shadow space-y-3">
              <h3 className="font-bold">{selected.name} 상담</h3>

              <input placeholder="사주 원국"
                value={saju}
                onChange={e=>setSaju(e.target.value)}
                className="border p-2 w-full rounded"/>

              <input placeholder="체지방%"
                value={bodyFat}
                onChange={e=>setBodyFat(e.target.value)}
                className="border p-2 w-full rounded"/>

              <input placeholder="골격근량"
                value={muscle}
                onChange={e=>setMuscle(e.target.value)}
                className="border p-2 w-full rounded"/>

              <input placeholder="기초대사량"
                value={bmr}
                onChange={e=>setBmr(e.target.value)}
                className="border p-2 w-full rounded"/>

              <input placeholder="위상각"
                value={phase}
                onChange={e=>setPhase(e.target.value)}
                className="border p-2 w-full rounded"/>

              <div className="font-bold">
                체질코드: {getCode()}
              </div>

              <button onClick={completeConsult}
                className="bg-green-600 text-white px-4 py-2 rounded">
                상담 완료 저장
              </button>
            </div>
          )}

        </div>
      )}

    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
